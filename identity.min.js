!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Identity=t()}(this,function(){"use strict";class e extends Error{constructor(e,t,n){super(e),this.code=t,this.details=n,this.name="IdentityResolutionError"}}class t{constructor(){this.mouseMovements=0,this.keyboardEvents=0,this.touchEvents=0,this.scrollEvents=0,this.firstInteractionTime=null,this.isCollecting=!1,this.pageLoadStart=performance.now(),this.startCollection()}startCollection(){if(this.isCollecting)return;this.isCollecting=!0;const e=()=>{this.mouseMovements++,this.recordFirstInteraction()},t=()=>{this.keyboardEvents++,this.recordFirstInteraction()},n=()=>{this.touchEvents++,this.recordFirstInteraction()},i=()=>{this.scrollEvents++,this.recordFirstInteraction()};let o=0;document.addEventListener("mousemove",t=>{const n=Date.now();n-o>100&&(e(),o=n)},{passive:!0}),document.addEventListener("keydown",t,{passive:!0}),document.addEventListener("keyup",t,{passive:!0}),document.addEventListener("touchstart",n,{passive:!0}),document.addEventListener("touchmove",n,{passive:!0}),document.addEventListener("touchend",n,{passive:!0});let s=0;document.addEventListener("scroll",()=>{const e=Date.now();e-s>200&&(i(),s=e)},{passive:!0}),document.addEventListener("click",()=>{this.recordFirstInteraction()},{passive:!0})}recordFirstInteraction(){null===this.firstInteractionTime&&(this.firstInteractionTime=performance.now())}detectAutomation(){const e=navigator,t=window,n=!!(e.webdriver||t.document.documentElement.getAttribute("webdriver")||e.__webdriver_unwrapped||e.__driver_evaluate||e.__selenium_evaluate||e.__selenium_unwrapped||e.__fxdriver_evaluate||e.__driver_unwrapped||t.callPhantom||t._phantom||t.phantom),i=!!(e.webdriver||(!e.plugins||0===e.plugins.length)&&e.userAgent.includes("HeadlessChrome")||e.userAgent.includes("Chrome")&&!t.chrome||t.__nightmare||e.__nightmare||t.Buffer||t.callPhantom||t._phantom);return{webdriver_present:n,headless_browser:i,automation_detected:!!(n||i||e.webdriver||t.document.__playwright||t.document.__puppeteer||t.document.$cdc_asdjflasutopfhvcZLmcfl_||t.document.$chrome_asyncScriptInfo||e.connection||t.__nightmare)}}checkFingerprintConsistency(){const e=navigator,t=window;let n=0;!e.userAgent.includes("Chrome")||e.plugins&&0!==e.plugins.length||n++;const i="ontouchstart"in t||e.maxTouchPoints>0,o=/Mobile|Android|iPhone|iPad/i.test(e.userAgent);!i&&o&&n++;const s=screen.width*(window.devicePixelRatio||1);(s<200||s>8e3)&&n++,e.languages&&0!==e.languages.length||n++;try{const e=(new Date).getTimezoneOffset(),t=Intl.DateTimeFormat().resolvedOptions().timeZone;0!==e||t||n++}catch(e){}return e.hardwareConcurrency&&(e.hardwareConcurrency<1||e.hardwareConcurrency>128)&&n++,n>=2}calculateSuspicionScore(e){let t=0;return 0===e.mouse_movements&&performance.now()>1e4&&(t+=30),0===e.keyboard_events&&performance.now()>5e3&&(t+=15),e.automation_detected&&(t+=50),e.webdriver_present&&(t+=40),e.headless_browser&&(t+=50),e.page_load_ms<100&&(t+=15),e.inconsistent_fingerprint&&(t+=25),0===e.mouse_movements&&0===e.keyboard_events&&0===e.touch_events&&0===e.scroll_events&&performance.now()>15e3&&(t+=35),null!==e.time_to_first_interaction_ms&&e.time_to_first_interaction_ms<50&&(t+=20),Math.min(t,100)}getSignals(){const e=this.detectAutomation(),t=this.checkFingerprintConsistency(),n=performance.now()-this.pageLoadStart,i={mouse_movements:this.mouseMovements,keyboard_events:this.keyboardEvents,touch_events:this.touchEvents,scroll_events:this.scrollEvents,webdriver_present:e.webdriver_present,headless_browser:e.headless_browser,automation_detected:e.automation_detected,page_load_ms:Math.round(n),time_to_first_interaction_ms:this.firstInteractionTime?Math.round(this.firstInteractionTime):null,inconsistent_fingerprint:t,suspicion_score:0};return i.suspicion_score=this.calculateSuspicionScore(i),i}}let n=null;function i(){"undefined"!=typeof window&&(n||(n=new t))}async function o(e,t){var o,l,d;i();const u=function(){const e=new URLSearchParams(window.location.search),t={};return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"].forEach(n=>{const i=e.get(n);i&&(t[n]=i)}),t}(),h={cpu_cores:navigator.hardwareConcurrency||0,ram_gb:navigator.deviceMemory,screen_resolution:`${screen.width}x${screen.height}`,screen_color_depth:screen.colorDepth,pixel_ratio:window.devicePixelRatio||1,max_touch_points:navigator.maxTouchPoints||0,connection_type:null===(o=navigator.connection)||void 0===o?void 0:o.effectiveType,downlink_mbps:null===(l=navigator.connection)||void 0===l?void 0:l.downlink,rtt_ms:null===(d=navigator.connection)||void 0===d?void 0:d.rtt,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,timezone_offset:(new Date).getTimezoneOffset(),languages:navigator.languages?Array.from(navigator.languages):[navigator.language],platform:navigator.platform,user_agent:navigator.userAgent,browser_family:s(),os_family:r(),device_type:a(),ip_subnet:"0.0.0",site_code:e,timestamp:Date.now(),cookie_anon_id:t,...u,landing_page:window.location.href,referrer:document.referrer||void 0};try{h.canvas_hash=function(){try{const e=document.createElement("canvas");e.width=280,e.height=60;const t=e.getContext("2d");if(!t)return null;t.textBaseline="top",t.font='14px "Arial"',t.textBaseline="alphabetic",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.font='11pt "Times New Roman"';const n="Cwm fjordbank glyphs vext quiz, ðŸ˜ƒðŸ”’";t.fillText(n,2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.font="bold 18px Arial",t.fillText(n,4,45),t.globalCompositeOperation="multiply",t.fillStyle="rgb(255,0,255)",t.beginPath(),t.arc(50,50,50,0,2*Math.PI,!0),t.closePath(),t.fill(),t.fillStyle="rgb(0,255,255)",t.beginPath(),t.arc(100,50,50,0,2*Math.PI,!0),t.closePath(),t.fill(),t.fillStyle="rgb(255,255,0)",t.beginPath(),t.arc(75,100,50,0,2*Math.PI,!0),t.closePath(),t.fill();return c(e.toDataURL())}catch(e){return null}}()}catch(e){}try{h.fonts=function(){const e=["monospace","sans-serif","serif"],t=["Arial","Verdana","Times New Roman","Courier New","Georgia","Palatino","Garamond","Bookman","Comic Sans MS","Trebuchet MS","Impact","Helvetica","Helvetica Neue","Lucida Grande","Geneva","Monaco","Apple Color Emoji","SF Pro Display","SF Mono","Liberation Sans","Ubuntu","DejaVu Sans","Noto Sans","Microsoft YaHei","SimSun","Hiragino Sans","MS Gothic","Malgun Gothic","Calibri","Cambria","Consolas","Constantia","Corbel","Candara","Franklin Gothic","Century Gothic"],n="mmmmmmmmmmlli",i="72px",o=document.getElementsByTagName("body")[0],s=document.createElement("span");s.style.fontSize=i,s.style.position="absolute",s.style.left="-9999px",s.style.visibility="hidden",s.innerHTML=n;const r={},a={};for(const t of e)s.style.fontFamily=t,o.appendChild(s),r[t]=s.offsetWidth,a[t]=s.offsetHeight,o.removeChild(s);const c=[];for(const n of t){let t=!1;for(const i of e){s.style.fontFamily=`'${n}', ${i}`,o.appendChild(s);const e=s.offsetWidth!==r[i]||s.offsetHeight!==a[i];if(o.removeChild(s),e){t=!0;break}}t&&c.push(n)}return c}()}catch(e){}try{h.audio_hash=await async function(){return new Promise((e,t)=>{try{const n=window.OfflineAudioContext||window.webkitOfflineAudioContext;if(!n)return void e("audio-not-supported");const i=new n(1,44100,44100),o=i.createOscillator();o.type="triangle",o.frequency.setValueAtTime(1e4,i.currentTime);const s=i.createDynamicsCompressor();s.threshold.setValueAtTime(-50,i.currentTime),s.knee.setValueAtTime(40,i.currentTime),s.ratio.setValueAtTime(12,i.currentTime),s.attack.setValueAtTime(0,i.currentTime),s.release.setValueAtTime(.25,i.currentTime),o.connect(s),s.connect(i.destination),o.start(0);const r=setTimeout(()=>{t(new Error("Audio fingerprint timeout"))},2e3);i.startRendering().then(t=>{clearTimeout(r);const n=t.getChannelData(0),i=c(Array.from(n.slice(0,100)).join(""));e(i)}).catch(e=>{clearTimeout(r),t(e)})}catch(t){e("audio-error")}})}()}catch(e){}try{const e=function(){const e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)return{vendor:"Unknown",renderer:"Unknown"};const n=t.getExtension("WEBGL_debug_renderer_info");if(n)return{vendor:t.getParameter(n.UNMASKED_VENDOR_WEBGL)||"Unknown",renderer:t.getParameter(n.UNMASKED_RENDERER_WEBGL)||"Unknown"};return{vendor:t.getParameter(t.VENDOR)||"Unknown",renderer:t.getParameter(t.RENDERER)||"Unknown"}}();h.webgl_vendor=e.vendor,h.webgl_renderer=e.renderer}catch(e){}try{h.webrtc_ips=await async function(){return new Promise(e=>{const t=[],n=setTimeout(()=>e(t),1e3);try{const i=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;if(!i)return void e(t);const o=new i({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});o.createDataChannel(""),o.onicecandidate=e=>{if(!e||!e.candidate||!e.candidate.candidate)return;const n=/([0-9]{1,3}(\.[0-9]{1,3}){3})/.exec(e.candidate.candidate);n&&n[1]&&!t.includes(n[1])&&t.push(n[1])},o.createOffer().then(e=>o.setLocalDescription(e)).catch(()=>{}),setTimeout(()=>{o.close(),clearTimeout(n),e(t)},500)}catch(i){clearTimeout(n),e(t)}})}()}catch(e){}try{h.media_devices_hash=await async function(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return"unsupported";const e=(await navigator.mediaDevices.enumerateDevices()).map(e=>({kind:e.kind,label:e.label?c(e.label):"unknown",groupId:e.groupId?c(e.groupId):"unknown"}));return c(JSON.stringify(e))}catch(e){return"error"}}()}catch(e){}try{const e=await async function(){try{const e=navigator;if(!e.getBattery)return null;const t=await e.getBattery();return{charging:t.charging,level:Math.round(100*t.level),chargingTime:t.chargingTime,dischargingTime:t.dischargingTime}}catch(e){return null}}();e&&(h.battery_hash=c(JSON.stringify(e)))}catch(e){}try{const e=(n||i(),n.getSignals());h.mouse_movements=e.mouse_movements,h.keyboard_events=e.keyboard_events,h.touch_events=e.touch_events,h.scroll_events=e.scroll_events,h.webdriver_present=e.webdriver_present,h.headless_browser=e.headless_browser,h.automation_detected=e.automation_detected,h.page_load_ms=e.page_load_ms,h.time_to_first_interaction_ms=e.time_to_first_interaction_ms,h.inconsistent_fingerprint=e.inconsistent_fingerprint,h.bot_suspicion_score=e.suspicion_score}catch(e){console.warn("Bot detection failed:",e)}return h}function s(){const e=navigator.userAgent;return e.includes("Edg/")||e.includes("EdgA/")||e.includes("EdgiOS/")?"Edge":e.includes("OPR/")||e.includes("Opera/")?"Opera":e.includes("OP/")?"Opera GX":e.includes("Brave/")||e.includes("Brave Chrome")?"Brave":e.includes("DuckDuckGo/")?"DuckDuckGo":e.includes("Mullvad")?"Mullvad Browser":e.includes("Avast/")||e.includes("ASW/")?"Avast Secure Browser":e.includes("AVG/")?"AVG Secure Browser":e.includes("Norton/")?"Norton Browser":e.includes("Iridium/")?"Iridium":e.includes("Ungoogled")?"Ungoogled Chromium":e.includes("Epic/")?"Epic Privacy Browser":e.includes("Arc/")?"Arc":e.includes("SigmaOS/")?"SigmaOS":e.includes("Orion/")?"Orion":e.includes("Wavebox/")?"Wavebox":e.includes("Sizzy/")?"Sizzy":e.includes("Mighty/")?"Mighty":e.includes("Bonsai/")?"Bonsai":e.includes("Ghost Browser")?"Ghost Browser":e.includes("Vivaldi/")?"Vivaldi":e.includes("Sidekick/")?"Sidekick":e.includes("Polypane/")?"Polypane":e.includes("Responsively/")?"Responsively":e.includes("Blisk/")?"Blisk":e.includes("LambdaTest/")?"LambdaTest":e.includes("Min/")?"Min":e.includes("Basilisk/")?"Basilisk":e.includes("Pale Moon/")||e.includes("PaleMoon/")?"Pale Moon":e.includes("K-Meleon/")?"K-Meleon":e.includes("Falkon/")?"Falkon":e.includes("qutebrowser/")?"qutebrowser":e.includes("Midori/")?"Midori":e.includes("surf/")?"Surf":e.includes("Luakit/")?"Luakit":e.includes("GX/")?"Opera GX":e.includes("Naver/")||e.includes("Whale/")?"Naver Whale":e.includes("Sleipnir/")?"Sleipnir":e.includes("Kinza/")?"Kinza":e.includes("CocCoc/")?"Coc Coc":e.includes("QQBrowser/")?"QQ Browser":e.includes("UCBrowser/")?"UC Browser":e.includes("Quark/")?"Quark":e.includes("Sogou")?"Sogou":e.includes("Maxthon/")?"Maxthon":e.includes("2345Explorer/")?"2345 Browser":e.includes("Baidu/")||e.includes("BaiduBrowser/")||e.includes("baidubrowser")?"Baidu Browser":e.includes("QHBrowser/")?"360 Browser":e.includes("Liebao/")?"Liebao":e.includes("TaoBrowser/")?"Tao Browser":e.includes("LBBROWSER")?"Cheetah Browser":e.includes("MxNitro/")?"MxNitro":e.includes("Smooz/")?"Smooz":e.includes("YaBrowser/")?"Yandex":e.includes("Atom/")?"Atom":e.includes("Amigo/")?"Amigo":e.includes("Tor Browser")?"Tor Browser":e.includes("OnionBrowser/")?"Onion Browser":e.includes("Zen/")?"Zen Browser":e.includes("Floorp/")?"Floorp":e.includes("Librewolf/")||e.includes("LibreWolf/")?"LibreWolf":e.includes("Waterfox/")?"Waterfox":e.includes("IceCat/")||e.includes("GNU IceCat")?"GNU IceCat":e.includes("Iceweasel/")?"Iceweasel":e.includes("SeaMonkey/")?"SeaMonkey":e.includes("Firefox Focus")?"Firefox Focus":e.includes("Firefox/")?"Firefox":e.includes("SamsungBrowser/")?"Samsung Internet":e.includes("MIUI Browser/")||e.includes("MiuiBrowser/")?"MIUI Browser":e.includes("HuaweiBrowser/")?"Huawei Browser":e.includes("VivoBrowser/")?"Vivo Browser":e.includes("OppoBrowser/")?"Oppo Browser":e.includes("OnePlus/")?"OnePlus Browser":e.includes("Puffin/")?"Puffin":e.includes("Dolphin/")?"Dolphin":e.includes("Coast/")?"Coast":e.includes("Mercury/")?"Mercury":e.includes("Aloha/")?"Aloha":e.includes("Cake/")?"Cake Browser":e.includes("Island/")?"Island":e.includes("Citrix/")?"Citrix Browser":e.includes("VMware/")?"VMware Browser":e.includes("Comodo/")||e.includes("Comodo_Dragon/")?"Comodo Dragon":e.includes("Slimjet/")?"Slimjet":e.includes("CentBrowser/")?"Cent Browser":e.includes("Torch/")?"Torch":e.includes("Rockmelt/")?"RockMelt":e.includes("Flock/")?"Flock":e.includes("Konqueror/")?"Konqueror":e.includes("Epiphany/")?"GNOME Web":e.includes("Dillo/")?"Dillo":e.includes("Links")?"Links":e.includes("Lynx/")?"Lynx":e.includes("w3m/")?"w3m":e.includes("Chrome/")?"Chrome":e.includes("Chromium/")?"Chromium":e.includes("Safari/")&&!e.includes("Chrome")?"Safari":e.includes("MSIE")||e.includes("Trident/")?"Internet Explorer":"Unknown"}function r(){const e=navigator.userAgent,t=navigator.platform;return t.includes("Win")?"Windows":t.includes("Mac")?"MacOS":t.includes("Linux")?"Linux":e.includes("Android")?"Android":e.includes("iOS")||e.includes("iPhone")||e.includes("iPad")?"iOS":"Unknown"}function a(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"mobile":"desktop"}function c(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t).toString(36)}function l(e,t="_anon_id",n=365){const i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3);const o=`expires=${i.toUTCString()}`;document.cookie=`${t}=${e};${o};path=/;SameSite=Lax`}async function d(e="identity-resolution-2025"){const t=new TextEncoder,n=await crypto.subtle.importKey("raw",t.encode(e),{name:"PBKDF2"},!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t.encode("cross-domain-salt"),iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!0,["encrypt","decrypt"])}class u{constructor(e){this.currentIdentity=null,this.ws=null,this.crossDomainSyncComplete=!1,this.ALLOWED_DOMAINS=["theindependent.sg","theindependent.co","theindependent.asia","theindependent.net","sportsry.com","localhost:3000","localhost:4000","localhost:5000"],this.config={defaultMode:"sync",debug:!1,timeout:1e4,cookieName:"_anon_id",cookieExpiration:365,autoCollect:!0,siteCode:"default",...e},this.log("SDK initialized (FINGERPRINT-FIRST with URL Parameter Sync)",this.config),this.checkAndProcessCrossDomainParameter(),this.setupLinkInterception()}async resolve(t,n){const i=t||this.config.defaultMode,o=await this.collectSignature();switch(i){case"sync":return this.resolveSync(o);case"async":return this.resolveAsync(o);case"optimistic":return this.resolveOptimistic(o);case"websocket":return this.resolveWebSocket(o,n);default:throw new e(`Invalid mode: ${i}`)}}async resolveSync(e){this.log("Resolving identity (sync)..."),await this.checkAndSyncCrossDomain(e);const t=await this.apiCall("/resolve",{signature:e,mode:"sync"}),n={anon_id:t.anon_id,visitor_id:t.visitor_id,confidence:t.confidence,is_new:t.is_new,matched_via:t.matched_via,fingerprint_quality:t.fingerprint_quality,bot_score:t.bot_score,linked_sessions:t.linked_sessions,score_breakdown:t.score_breakdown,session_id:t.session_id};return this.currentIdentity=n,l(n.anon_id,this.config.cookieName,this.config.cookieExpiration),n.visitor_id&&this.setLocalStorageVisitorId(n.visitor_id),this.log("Identity resolved (sync)",n),n}async resolveAsync(e){this.log("Resolving identity (async)...");const t=await this.apiCall("/resolve",{signature:e,mode:"async"});return this.log("Identity resolution queued",t),{request_id:t.request_id,poll:async()=>this.pollResult(t.request_id)}}async resolveOptimistic(e){this.log("Resolving identity (optimistic)...");const t=await this.apiCall("/resolve",{signature:e,mode:"optimistic"});return this.log("Temp identity assigned",t),this.currentIdentity={anon_id:t.anon_id,confidence:0,is_new:!0,matched_via:"optimistic_temp"},l(t.anon_id,this.config.cookieName,this.config.cookieExpiration),{temp_id:t.anon_id,request_id:t.request_id,waitForFinal:async()=>{const e=await this.pollResult(t.request_id);return this.currentIdentity=e,l(e.anon_id,this.config.cookieName,this.config.cookieExpiration),e}}}async resolveWebSocket(e,t){this.log("Resolving identity (websocket)...");const n=`client-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,i=await this.apiCall("/resolve",{signature:e,mode:"websocket",client_id:n});return this.log("WebSocket channel assigned",i),this.connectWebSocket(n,i.channel,e=>{this.currentIdentity=e,l(e.anon_id,this.config.cookieName,this.config.cookieExpiration),(null==t?void 0:t.onResult)&&t.onResult(e)},t),{request_id:i.request_id}}async pollResult(t,n=20){this.log(`Polling for result: ${t}`);for(let i=0;i<n;i++){await this.sleep(500);const n=await this.getResult(t);if("completed"===n.status&&n.result){this.log("Result received",n.result);return{anon_id:n.result.anon_id,confidence:n.result.confidence,is_new:n.result.is_new,matched_via:n.result.matched_via,linked_sessions:n.result.linked_sessions,score_breakdown:n.result.score_breakdown}}if("failed"===n.status)throw new e(`Resolution failed: ${n.error}`,"RESOLUTION_FAILED",n);if("not_found"===n.status)throw new e("Request not found","NOT_FOUND",n)}throw new e("Polling timeout","TIMEOUT",{request_id:t,maxAttempts:n})}async getResult(e){return this.apiCall(`/resolve/result/${e}`,void 0,"GET")}connectWebSocket(e,t,n,i){const o=this.config.apiUrl.replace("http","ws")+`/ws/${e}`;this.log(`Connecting to WebSocket: ${o}`),this.ws=new WebSocket(o),this.ws.onopen=()=>{this.log("WebSocket connected"),(null==i?void 0:i.onConnected)&&i.onConnected(),this.ws.send(JSON.stringify({action:"subscribe",channel:t}))},this.ws.onmessage=e=>{const t=JSON.parse(e.data);if(this.log("WebSocket message",t),"result"===t.type&&t.data){const e=t.data;n({anon_id:e.anon_id,confidence:e.confidence,is_new:e.is_new,matched_via:e.matched_via,linked_sessions:e.linked_sessions,score_breakdown:e.score_breakdown})}else"error"===t.type&&(null==i?void 0:i.onError)&&i.onError(t.message)},this.ws.onerror=e=>{this.log("WebSocket error",e),(null==i?void 0:i.onError)&&i.onError("WebSocket connection error")},this.ws.onclose=()=>{this.log("WebSocket disconnected"),(null==i?void 0:i.onDisconnected)&&i.onDisconnected(),(null==i?void 0:i.reconnect)&&setTimeout(()=>{this.connectWebSocket(e,t,n,i)},i.reconnectInterval||5e3)}}disconnectWebSocket(){this.ws&&(this.ws.close(),this.ws=null)}async trackEvent(t,n,i){if(!this.currentIdentity)throw new e("No identity resolved. Call resolve() first.","NO_IDENTITY");const o={anon_id:this.currentIdentity.anon_id,event_type:t,event_data:n,metadata:i,timestamp:Date.now(),session_id:this.currentIdentity.session_id};return this.log("Tracking event",o),this.apiCall("/event",o)}getIdentity(){return this.currentIdentity}getAnonId(){var e;return(null===(e=this.currentIdentity)||void 0===e?void 0:e.anon_id)||null}async collectSignature(){const e=function(e="_anon_id"){const t=document.cookie.split(";");for(const n of t){const[t,i]=n.trim().split("=");if(t===e)return i}return null}(this.config.cookieName);return o(this.config.siteCode,e||void 0)}async checkAndSyncCrossDomain(e){const t=["theindependent.sg","theindependent.co","theindependent.asia","theindependent.net","sportsry.com","localhost:3000","localhost:4000","localhost:5000"],n=window.location.hostname+(window.location.port?":"+window.location.port:""),i=document.referrer;if(!i)return void this.log("No referrer - not a cross-domain navigation");let o;try{const e=new URL(i);o=e.hostname+(e.port?":"+e.port:"")}catch(e){return void this.log("Invalid referrer URL")}const s=t.some(e=>o.includes(e)),r=t.some(e=>n.includes(e));if(s&&r&&o!==n){this.log(`Cross-domain navigation detected: ${o} â†’ ${n}`);try{const t=await this.apiCall("/v1/sync/cross-domain",e,"POST",{"X-From-Domain":o,Referer:i});t.anon_id&&(l(t.anon_id,this.config.cookieName,this.config.cookieExpiration),this.log(`Cross-domain sync successful: anon_id=${t.anon_id}, confidence=${t.confidence}`))}catch(e){this.log("Cross-domain sync failed, continuing with regular resolution",e)}}else this.log("Not a cross-domain navigation or domain not whitelisted")}async checkAndProcessCrossDomainParameter(){var e;try{const t=new URLSearchParams(window.location.search).get("_uid");if(!t)return void this.log("[URL_PARAM] No cross-domain parameter found");this.log("[URL_PARAM] Cross-domain parameter detected, decrypting...");const n=await async function(e){try{const t=await d(),n=e.replace(/-/g,"+").replace(/_/g,"/"),i=n+"==".substring(0,(4-n.length%4)%4),o=Uint8Array.from(atob(i),e=>e.charCodeAt(0)),s=o.slice(0,12),r=o.slice(12),a=await crypto.subtle.decrypt({name:"AES-GCM",iv:s},t,r),c=(new TextDecoder).decode(a),l=JSON.parse(c),u=Date.now()-l.timestamp;if(u>6e4)throw new Error("Cross-domain parameter expired (>60s old)");if(u<-5e3)throw new Error("Cross-domain parameter timestamp is in the future");return l}catch(e){throw console.error("Decryption failed:",e),new Error("Failed to decrypt cross-domain payload")}}(t);this.log("[URL_PARAM] Decrypted payload:",{visitor_id:(null===(e=n.visitor_id)||void 0===e?void 0:e.substring(0,16))+"...",from_domain:n.from_domain,age_ms:Date.now()-n.timestamp}),this.setLocalStorageVisitorId(n.visitor_id),n.anon_id&&(l(n.anon_id,this.config.cookieName,this.config.cookieExpiration),this.log("[URL_PARAM] Updated cookie with anon_id:",n.anon_id)),this.crossDomainSyncComplete=!0;const i=new URL(window.location.href);i.searchParams.delete("_uid"),window.history.replaceState({},"",i.toString()),this.log("[URL_PARAM] Cross-domain sync complete, URL cleaned")}catch(e){this.log("[URL_PARAM] Failed to process cross-domain parameter:",e)}}setupLinkInterception(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.interceptLinks()):this.interceptLinks()}interceptLinks(){document.addEventListener("click",async e=>{var t,n;try{const i=e.target.closest("a");if(!i||!i.href)return;const o=new URL(i.href,window.location.href),s=window.location.hostname+(window.location.port?":"+window.location.port:""),r=o.hostname+(o.port?":"+o.port:""),a=s!==r,c=this.ALLOWED_DOMAINS.some(e=>r.includes(e));if(!a||!c)return;if(o.searchParams.has("_uid"))return;this.log("[LINK_INTERCEPT] Cross-domain link detected:",{from:s,to:r}),this.currentIdentity||(this.log("[LINK_INTERCEPT] No identity yet, resolving..."),await this.resolve());const l={visitor_id:(null===(t=this.currentIdentity)||void 0===t?void 0:t.visitor_id)||this.getLocalStorageVisitorId()||"",anon_id:null===(n=this.currentIdentity)||void 0===n?void 0:n.anon_id,timestamp:Date.now(),from_domain:s};if(!l.visitor_id)return void this.log("[LINK_INTERCEPT] No visitor_id available, skipping");const u=await async function(e){try{const t=await d(),n=new TextEncoder,i=JSON.stringify(e),o=crypto.getRandomValues(new Uint8Array(12)),s=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,n.encode(i)),r=new Uint8Array(o.length+s.byteLength);return r.set(o,0),r.set(new Uint8Array(s),o.length),btoa(String.fromCharCode(...r)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}catch(e){throw console.error("Encryption failed:",e),new Error("Failed to encrypt cross-domain payload")}}(l);o.searchParams.set("_uid",u),i.href=o.toString(),this.log("[LINK_INTERCEPT] Added encrypted parameter to link")}catch(e){this.log("[LINK_INTERCEPT] Failed to process link:",e)}}),this.log("[LINK_INTERCEPT] Link interception enabled")}setLocalStorageVisitorId(e){try{localStorage.setItem("_visitor_id",e),this.log("[LOCALSTORAGE] Stored visitor_id")}catch(e){this.log("[LOCALSTORAGE] Failed to store visitor_id (blocked)")}}getLocalStorageVisitorId(){try{return localStorage.getItem("_visitor_id")}catch(e){return null}}async apiCall(t,n,i="POST",o){const s=`${this.config.apiUrl}/api${t}`,r={method:i,headers:{"Content-Type":"application/json","X-API-Key":this.config.apiKey,...o||{}}};n&&(r.body=JSON.stringify(n)),this.log(`API ${i} ${s}`,n);const a=new AbortController,c=setTimeout(()=>a.abort(),this.config.timeout);try{const t=await fetch(s,{...r,signal:a.signal});if(clearTimeout(c),!t.ok){const n=await t.json().catch(()=>({error:t.statusText}));throw new e(n.error||"API request failed",`HTTP_${t.status}`,n)}const n=await t.json();return this.log("API response",n),n}catch(t){if(clearTimeout(c),"AbortError"===t.name)throw new e("Request timeout","TIMEOUT");throw t}}sleep(e){return new Promise(t=>setTimeout(t,e))}log(e,t){this.config.debug&&console.log(`[IdentitySDK] ${e}`,t||"")}}let h=null,m=!1;const g={init(e,t,n={}){m?console.warn("[Identity] Already initialized, skipping..."):(h=new u({apiUrl:"https://analytics.tigress.cloud",apiKey:t,siteCode:e,debug:n.debug||!1,cookieDomain:n.cookieDomain,sessionTimeout:n.sessionTimeout,enableBotDetection:!1!==n.enableBotDetection,botDetectionStrict:n.botDetectionStrict||!1,...n}),m=!0,this.resolve("optimistic").then(e=>(n.debug&&console.log("[Identity] Initialized:",e.temp_id),this.trackPageView())).catch(e=>{console.error("[Identity] Initialization failed:",e)}))},async resolve(e="optimistic"){return this._ensureInitialized(),h.resolve(e)},async trackEvent(e,t={}){this._ensureInitialized();try{await h.trackEvent(e,t),h.config.debug&&console.log(`[Identity] Event tracked: ${e}`,t)}catch(t){console.error(`[Identity] Failed to track event: ${e}`,t)}},async trackPageView(e={}){this._ensureInitialized();const t={page_url:window.location.href,page_title:document.title,page_path:window.location.pathname,referrer:document.referrer||void 0,...e};return this.trackEvent("page_view",t)},async linkUser(e,t={}){this._ensureInitialized();try{await h.linkAuthenticatedUser(e,t),h.config.debug&&console.log(`[Identity] User linked: ${e}`)}catch(e){console.error("[Identity] Failed to link user:",e)}},getAnonymousId:()=>h&&h.currentAnonId||null,getSessionId:()=>h&&h.currentSessionId||null,isReady:()=>m&&null!==h,version:"2.0.0",_ensureInitialized(){if(!m||!h)throw new Error("[Identity] SDK not initialized. Call Identity.init() first.")}};return"undefined"!=typeof window&&(window.Identity=g),g});
//# sourceMappingURL=identity.min.js.map
